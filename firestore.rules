rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isTeacher() {
      return request.auth != null && getUserData().role == 'teacher';
    }
    
    function isStudent() {
      return request.auth != null && getUserData().role == 'student';
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isTeacher());
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Courses collection
    match /courses/{courseId} {
      // Anyone authenticated can read published courses
      allow read: if request.auth != null && 
        (resource.data.isPublished == true || 
         request.auth.uid == resource.data.teacherId);
      // Only teachers can create courses
      allow create: if request.auth != null && isTeacher() &&
        request.auth.uid == request.resource.data.teacherId;
      // Only course owner (teacher) can update/delete
      allow update, delete: if request.auth != null && 
        request.auth.uid == resource.data.teacherId;

      // Allow students to increment totalStudents by exactly +1.
      // This supports the enrollment flow without giving broad write access.
      allow update: if request.auth != null && isStudent() &&
        request.resource.data.teacherId == resource.data.teacherId &&
        request.resource.data.totalStudents == resource.data.totalStudents + 1;
    }
    
    // Lessons collection
    match /lessons/{lessonId} {
      // Anyone authenticated can read lessons
      allow read: if request.auth != null;
      // Only teachers can write lessons
      allow write: if request.auth != null && isTeacher();
    }
    
    // Enrollments collection
    match /enrollments/{enrollmentId} {
      // Students can read their own enrollments
      // Teachers can read enrollments where they are the teacherId
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.studentId || 
         (isTeacher() && request.auth.uid == resource.data.teacherId));
      // Only students can create enrollments, but must include teacherId
      allow create: if request.auth != null && isStudent() &&
        request.auth.uid == request.resource.data.studentId &&
        request.resource.data.teacherId != null;
      // Students and teachers can update enrollments
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.studentId || 
         (isTeacher() && request.auth.uid == resource.data.teacherId));
    }
    
    // Progress collection
    match /progress/{progressId} {
      // Students can read their own progress
      // Teachers can read progress for their courses
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.studentId || 
         (isTeacher() && request.auth.uid == get(/databases/$(database)/documents/courses/$(resource.data.courseId)).data.teacherId));
      // Students can create/update their own progress
      allow create: if request.auth != null && isStudent() &&
        request.auth.uid == request.resource.data.studentId;
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.studentId;
    }
  }
}
