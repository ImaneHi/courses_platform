<ion-header translucent>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>

    <ion-title>Teacher Dashboard</ion-title>

    <ion-buttons slot="end">
      <ion-button color="primary" routerLink="/upload">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        New Course
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- ================= COURSES VIEW ================= -->
  <ng-container *ngIf="!selectedCourseId">

    <!-- Welcome Section -->
    <div class="welcome-section" *ngIf="currentUser">
      <h1>Welcome back, {{ currentUser.firstName || 'Teacher' }}!</h1>
      <p class="welcome-subtitle">Here's an overview of your teaching activity</p>
    </div>

    <!-- Statistics Cards -->
    <ion-grid class="stats-grid" *ngIf="!isLoading">
      <ion-row>
        <ion-col size="12" size-md="6" size-lg="3">
          <ion-card class="stat-card stat-card-primary">
            <ion-card-content>
              <div class="stat-icon">
                <ion-icon name="people-outline"></ion-icon>
              </div>
              <h2>{{ statistics.totalStudents }}</h2>
              <p>Total Students</p>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6" size-lg="3">
          <ion-card class="stat-card stat-card-success">
            <ion-card-content>
              <div class="stat-icon">
                <ion-icon name="book-outline"></ion-icon>
              </div>
              <h2>{{ statistics.totalCourses }}</h2>
              <p>Total Courses</p>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6" size-lg="3">
          <ion-card class="stat-card stat-card-warning">
            <ion-card-content>
              <div class="stat-icon">
                <ion-icon name="school-outline"></ion-icon>
              </div>
              <h2>{{ statistics.totalEnrollments }}</h2>
              <p>Total Enrollments</p>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6" size-lg="3">
          <ion-card class="stat-card stat-card-info">
            <ion-card-content>
              <div class="stat-icon">
                <ion-icon name="document-text-outline"></ion-icon>
              </div>
              <h2>{{ statistics.totalLessons }}</h2>
              <p>Total Lessons</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="ion-text-center ion-padding">
      <ion-spinner></ion-spinner>
      <p>Loading statistics...</p>
    </div>

    <ion-text color="medium" *ngIf="!isLoading">
      <h2 class="section-title">My Courses</h2>
    </ion-text>

    <!-- Empty State -->
    <ion-card *ngIf="teacherCourses.length === 0" class="empty-card">
      <ion-card-content class="ion-text-center">
        <ion-icon name="school-outline" size="large"></ion-icon>
        <h3>No courses yet</h3>
        <p>Create your first course to start teaching.</p>
        <ion-button expand="block" color="primary" routerLink="/upload">
          Create Course
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Courses Grid -->
    <ion-grid *ngIf="teacherCourses.length > 0">
      <ion-row>
        <ion-col
          size="12"
          size-md="6"
          size-lg="4"
          *ngFor="let course of teacherCourses"
        >

          <ion-card class="course-card">

            <img
              *ngIf="course.coverImage"
              [src]="course.coverImage"
              class="course-image"
            />

            <ion-card-header>
              <ion-card-title>{{ course.title }}</ion-card-title>
              <ion-card-subtitle>
                {{ course.category }} • {{ course.level }}
              </ion-card-subtitle>
            </ion-card-header>

            <ion-card-content>
              <p class="course-description">
                {{ course.description || 'No description provided.' }}
              </p>

              <div class="course-meta">
                <ion-chip color="primary">
                  <ion-icon name="people-outline"></ion-icon>
                  {{ course.totalStudents || 0 }} students
                </ion-chip>
                <ion-chip color="secondary">
                  <ion-icon name="book-outline"></ion-icon>
                  {{ getLessonCount(course.id!) }} lessons
                </ion-chip>
                <ion-chip color="success">
                  <ion-icon name="star-outline"></ion-icon>
                  {{ course.rating || 0 }}
                </ion-chip>
              </div>
            </ion-card-content>

            <ion-footer class="course-actions">
              <ion-button fill="clear" color="primary" [routerLink]="['/course', course.id]">
                <ion-icon name="eye-outline" slot="start"></ion-icon>
                View
              </ion-button>

              <ion-button fill="clear" color="secondary"
                [routerLink]="['/manage-lessons', course.id]">
                <ion-icon name="book-outline" slot="start"></ion-icon>
                Lessons
              </ion-button>

              <ion-button fill="clear" color="tertiary"
                (click)="viewEnrollments(course.id!)">
                <ion-icon name="people-outline" slot="start"></ion-icon>
                Enrollments
              </ion-button>

              <ion-button fill="clear" color="medium"
                (click)="viewStudentProgress(course.id!)">
                <ion-icon name="analytics-outline" slot="start"></ion-icon>
                Progress
              </ion-button>

              <ion-button fill="clear" color="danger"
                (click)="deleteCourse(course.id!)">
                <ion-icon name="trash-outline" slot="start"></ion-icon>
                Delete
              </ion-button>
            </ion-footer>

          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

  </ng-container>

  <!-- ================= PROGRESS VIEW ================= -->
  <ng-container *ngIf="selectedCourseId">

    <ion-button fill="clear" color="medium"
      (click)="selectedCourseId = null; studentProgress = []">
      <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
      Back to Courses
    </ion-button>

    <h2 class="section-title">Student Progress</h2>

    <!-- Stats -->
    <ion-grid class="stats-grid">
      <ion-row>
        <ion-col size="4">
          <ion-card class="stat-card">
            <ion-card-content>
              <h2>{{ getEnrolledCount() }}</h2>
              <p>Enrolled</p>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="4">
          <ion-card class="stat-card">
            <ion-card-content>
              <h2>{{ getCompletedCount() }}</h2>
              <p>Completed</p>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="4">
          <ion-card class="stat-card">
            <ion-card-content>
              <h2>{{ getAverageProgress() }}%</h2>
              <p>Average</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Loading -->
    <div *ngIf="isLoadingProgress" class="ion-text-center">
      <ion-spinner></ion-spinner>
      <p>Loading progress...</p>
    </div>

    <!-- Students -->
    <ion-list *ngIf="!isLoadingProgress && studentProgress.length > 0">
      <ion-item *ngFor="let progress of studentProgress">
        <ion-avatar slot="start">
          <img [src]="'https://ui-avatars.com/api/?name=' + (progress.studentName || 'Student')" />
        </ion-avatar>

        <ion-label>
          <h3>{{ progress.studentName || 'Student ' + progress.studentId }}</h3>
          <p>{{ progress.studentEmail || '' }}</p>
          <p class="progress-info">
            Completed: {{ progress.completedLessons?.length || 0 }} lessons
            • Quizzes: {{ getCompletedQuizzesCount(progress) }}
          </p>
        </ion-label>

        <div slot="end" class="progress-display">
          <ion-text [color]="getProgressColor(progress.overallProgress)">
            <strong>{{ progress.overallProgress || 0 }}%</strong>
          </ion-text>
          <ion-progress-bar
            [value]="(progress.overallProgress || 0) / 100"
            [color]="getProgressColor(progress.overallProgress)">
          </ion-progress-bar>
        </div>
      </ion-item>
    </ion-list>

    <p *ngIf="!isLoadingProgress && studentProgress.length === 0"
      class="ion-text-center">
      No students enrolled yet.
    </p>

  </ng-container>

</ion-content>
