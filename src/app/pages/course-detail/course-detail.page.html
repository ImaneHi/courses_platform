<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/courses"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ course?.title || 'Course Details' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Loading course details...</p>
  </div>

  <!-- Course Not Found -->
  <div *ngIf="!isLoading && !course" class="not-found">
    <h2>Course Not Found</h2>
    <p>The course you're looking for doesn't exist or has been removed.</p>
    <ion-button routerLink="/courses" fill="solid">
      <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
      Back to Courses
    </ion-button>
  </div>

  <!-- Course Details -->
  <div *ngIf="!isLoading && course">
    <!-- Course Header -->
    <ion-card class="course-header-card">
      <img [src]="course.coverImage || 'assets/icon/favicon.png'" 
           [alt]="course.title" class="course-cover" />
      <ion-card-header>
        <ion-card-title>{{ course.title || 'Course Details' }}</ion-card-title>
        <ion-card-subtitle>
          <ion-badge color="primary">{{ course.category }}</ion-badge>
          <ion-badge color="secondary">{{ course.level }}</ion-badge>
        </ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <p>{{ course.description }}</p>
        <div class="course-meta">
          <p><strong>Teacher:</strong> {{ course.teacherName }}</p>
          <p><strong>Duration:</strong> {{ course.duration || 0 }} hours</p>
          <p><strong>Students:</strong> {{ course.totalStudents || 0 }}</p>
          <p><strong>Lessons:</strong> {{ lessons.length }}</p>
          <p><strong>Rating:</strong> 
            <ion-icon name="star" color="warning"></ion-icon>
            {{ course.rating || 0 }}/5
          </p>
          <p><strong>Price:</strong> ${{ course.price }}</p>
        </div>
        <div class="course-actions" *ngIf="isStudent">
          <ion-button 
            *ngIf="!isEnrolled" 
            expand="block" 
            color="primary" 
            (click)="enroll()">
            <ion-icon slot="start" name="person-add-outline"></ion-icon>
            Enroll Now
          </ion-button>
          <ion-button 
            *ngIf="isEnrolled" 
            expand="block" 
            color="success" 
            routerLink="/student-dashboard">
            <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
            Already Enrolled - Go to Dashboard
          </ion-button>
        </div>
        <div class="course-actions" *ngIf="!currentUser">
          <ion-button 
            expand="block" 
            color="primary" 
            routerLink="/login">
            <ion-icon slot="start" name="log-in-outline"></ion-icon>
            Login to Enroll
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Course Lessons -->
    <ion-card class="lessons-card">
      <ion-card-header>
        <ion-card-title>Course Lessons</ion-card-title>
        <ion-card-subtitle>{{ lessons.length }} lessons available</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div *ngIf="lessons.length === 0" class="no-lessons">
          <ion-icon name="book-outline" size="large"></ion-icon>
          <h3>No Lessons Yet</h3>
          <p>This course doesn't have any lessons yet. Check back later!</p>
        </div>
        
        <ion-list *ngIf="lessons.length > 0">
          <ion-item *ngFor="let lesson of lessons; let i = index" 
                    button (click)="openLesson(lesson)">
            <ion-avatar slot="start">
              <ion-icon name="play-circle-outline" size="large"></ion-icon>
            </ion-avatar>
            <ion-label>
              <h2>Lesson {{ i + 1 }}: {{ lesson.title }}</h2>
              <p>{{ lesson.description }}</p>
              <p *ngIf="lesson.duration">
                <ion-icon name="time-outline"></ion-icon>
                {{ lesson.duration }} minutes
              </p>
            </ion-label>
            <ion-badge slot="end" *ngIf="isLessonCompleted(lesson.id)" color="success">
              <ion-icon name="checkmark-outline"></ion-icon>
              Completed
            </ion-badge>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Course Files -->
    <ion-card class="files-card" *ngIf="course.files && course.files.length > 0">
      <ion-card-header>
        <ion-card-title>Course Materials</ion-card-title>
        <ion-card-subtitle>{{ course.files.length }} files available</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let file of course.files" button>
            <ion-icon 
              slot="start" 
              [name]="getFileIcon(file.type || '')">
            </ion-icon>
            <ion-label (click)="viewFile(file)">
              <h2>{{ file.name }}</h2>
              <p>{{ file.type || 'Unknown type' }} â€¢ {{ formatFileSize(file.size || 0) }}</p>
            </ion-label>
            <ion-button 
              slot="end" 
              fill="clear" 
              color="primary"
              (click)="viewFile(file)">
              <ion-icon name="eye-outline"></ion-icon>
            </ion-button>
            <ion-button 
              slot="end" 
              fill="clear" 
              color="secondary"
              (click)="downloadFile(file)">
              <ion-icon name="download-outline"></ion-icon>
            </ion-button>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Teacher Actions (if teacher owns this course) -->
    <ion-card class="teacher-actions" *ngIf="isTeacher()">
      <ion-card-header>
        <ion-card-title>Course Management</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="6">
              <ion-button expand="block" fill="outline" [routerLink]="['/manage-lessons', course.id]">
                <ion-icon slot="start" name="book-outline"></ion-icon>
                Manage Lessons
              </ion-button>
            </ion-col>
            <ion-col size="12" size-md="6">
              <ion-button expand="block" fill="outline" routerLink="/upload">
                <ion-icon slot="start" name="cloud-upload-outline"></ion-icon>
                Upload Materials
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Lesson Modal -->
  <ion-modal [isOpen]="!!selectedLesson" (willDismiss)="closeLesson()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ selectedLesson?.title }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeLesson()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="selectedLesson">
          <h3>{{ selectedLesson.title }}</h3>
          <p>{{ selectedLesson.description }}</p>
          
          <!-- Video Content -->
          <div class="video-content" *ngIf="selectedLesson.type === 'video'">
            <h4>Video Lesson</h4>
            <div class="video-placeholder">
              <ion-icon name="videocam-outline" size="large"></ion-icon>
              <p>Video: {{ selectedLesson.videoUrl }}</p>
              <ion-button expand="block" fill="outline" [href]="selectedLesson.videoUrl" target="_blank">
                <ion-icon slot="start" name="play-outline"></ion-icon>
                Watch Video
              </ion-button>
            </div>
          </div>
          
          <!-- Document Content -->
          <div class="document-content" *ngIf="selectedLesson.type === 'document'">
            <h4>Document Lesson</h4>
            <div class="document-placeholder">
              <ion-icon name="document-text-outline" size="large"></ion-icon>
              <p>Document: {{ selectedLesson.documentUrl }}</p>
              <ion-button expand="block" fill="outline" [href]="selectedLesson.documentUrl" target="_blank">
                <ion-icon slot="start" name="document-outline"></ion-icon>
                View Document
              </ion-button>
            </div>
          </div>
          
          <!-- Text Content -->
          <div class="text-content" *ngIf="selectedLesson.type === 'text'">
            <h4>Lesson Content</h4>
            <div class="lesson-content">
              <p>{{ selectedLesson.content || 'No content available for this lesson.' }}</p>
            </div>
          </div>
          
          <!-- Quiz Section -->
          <div class="quiz-section" *ngIf="selectedLesson.quiz">
            <h4>Lesson Quiz</h4>
            <p>Test your knowledge with this lesson's quiz.</p>
            <ion-button
              *ngIf="isSelectedLessonCompleted()"
              expand="block"
              (click)="takeQuiz(selectedLesson.id)">
              <ion-icon slot="start" name="help-circle-outline"></ion-icon>
              Take Quiz
            </ion-button>
            <ion-text *ngIf="!isSelectedLessonCompleted()" color="medium">
              <p>Please mark the lesson as complete to unlock the quiz.</p>
            </ion-text>
          </div>
          
          <!-- Mark as Complete -->
          <ion-button expand="block" color="success" (click)="markLessonCompleted(selectedLesson.id)">
            <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
            Mark as Complete
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
